{% extends "base.html" %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

{% block content %}
<style>
    tbody tr:hover {
        cursor: move;
    }
    .tooltip {
        pointer-events: none; /* Prevents the tooltip from blocking other elements */
    }
    .tooltip.show {
        opacity: 1;
    }
    .tooltip-inner {
        max-width: none; /* Remove the max-width restriction */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Add a subtle shadow for depth */
    }
    .note-expander {
        display: none;
        position: absolute;
        left: 10px;
        bottom: 5px;
        cursor: pointer;
    }

    .noteGroup:hover .note-expander {
        display: block; /* Show the expander arrow on hover */
    }



    /* Adjust arrow color to match tooltip background */
    .tooltip.bs-tooltip-top .arrow::before, .tooltip.bs-tooltip-auto .arrow::before {
        border-top-color: #333;
    }



</style>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Welcome to the SDR Dashboard</h1>
        <!-- Button to Open the Modal -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
            Add New Account
        </button>
    </div>
    <p>Here you can view your sales metrics and manage your accounts.</p>

    <!-- Add your dashboard content here -->
    <h2>Accounts</h2>
    <table class="table table-bordered" style="width:100%" id="myTable">
        <thead>
        <tr>
            <th>Name</th>
            <th>Tier</th>
            <th>State</th>
            <th>Opportunities</th>
            <th>Notes</th>
            <th>Last Interaction</th>
            <th>Events</th>
            <th>Top 5 Contacts</th>
            <th>Menu</th>
        </tr>
        </thead>
        <tbody>
        {% for account in accounts %}
            <tr>
                <td><a href="{{ url_for('account_details', account_id=account.Id) }}" style="font-weight: lighter; color: steelblue" >{{ account.Name }}</a></td>
                <td>{{ account.Score|int }}</td>
                <td>{{ account.BillingState }}</td>
                <td style="background-color: {{ status_color[account.Id] }}; text-align: center;">

                    {% if account.Id in open_opps_by_account %}
                        {{ open_opps_by_account[account.Id] }} Open
                    {% elif account.Id in closed_opps_by_account %}
                        {{ closed_opps_by_account[account.Id] }} Won in Last 12 Months
                    {% else %}
                        No opportunities
                    {% endif %}
                </td>


                {#            make an editable input for cell#}
                <td>
                    <div class="input-group noteGroup">
                        <textarea class="form-control note-textarea" readonly aria-label="Recipient's username">{{ account.Notes }}</textarea>
                        <button class="btn btn-outline-secondary save-note-btn" type="button" style="display:none;">Save</button>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-down note-expander" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </div>


                </td>


                <td data-account-id="{{ account.Id }}" class="last-interaction-cell" style="font-weight: lighter; color: steelblue">{% set last_interaction = get_last_interaction(account.Id) %}
                    {% if last_interaction != None %}
                        <a href="{{ url_for('interaction_details', interaction_id=last_interaction.id) }}" style="font-weight: lighter; color: steelblue">{{ last_interaction.timestamp|time_since }}</a>
                    {% else %}
                        :(
                    {% endif %}</td>
                {% if account.BillingCity is not none %}
                    <td><a href="{{ url_for('event_list', account_id=account.Id, event_city=account.BillingCity) }}" style="font-weight: lighter; color: steelblue">{{ account_event_counts[account.Id] if account.Id in account_event_counts else 0 }}</a>
                    </td>
                {% else %}
                    <td style="font-weight: lighter; color: steelblue">{{ account_event_counts[account.Id] if account.Id in account_event_counts else 0 }}</td>
                {% endif %}
                <td>
                    {% for contact in top5[account.Id] %}
                        <a href="{{ url_for('contact_details', contact_id=contact.Id) }}">{{ contact.Name }} <br> {{ contact.Title }}</a><br><br>
                    {% endfor %}
                </td>

                <td>
                    <button type="button" class="btn btn-info open-contact-modal" data-bs-toggle="modal" data-bs-target="#viewContactModal" data-account-id="{{ account.Id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="2 0 11 19">
                            <path d="M9.5 9a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-7a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0zm0 14a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0z"></path>
                        </svg>
                    </button>
                </td>

            </tr>
        {% endfor %}
        </tbody>
    </table>

        <div class="modal fade" id="viewContactModal" tabindex="-1" aria-labelledby="viewContactModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="log_a_call">
                        <div class="modal-header">
                            <h5 class="modal-title" id="viewContactModalLabel">Contact Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <strong>Account:</strong> <span id="contactAccount"></span>
                            </div>

                            <div class="mb-3">
                                <label for="callSubject" class="form-label">Call Subject</label>
                                <input type="text" class="form-control" id="callSubject" required>
                            </div>
                            <div class="mb-3">
                                <label for="callDescription" class="form-label">Call Description</label>
                                <input type="text" class="form-control" id="callDescription" required>
                            </div>
                            {#                        add dropdown for contacts from the account#}
                            <div class="mb-3">
                                <label for="contact" class="form-label">Contact</label>
                                <select class="form-select" id="contact" required>
                                    <option selected disabled value="">Select a Contact</option>
                                    {% for contact in contacts %}
                                        <option value="{{ contact.id }}">{{ contact.Name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Log a Call button -->
                            <button type="button" class="btn btn-success" id="logCallButton">Log a Call</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Modal -->
        <div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addAccountModalLabel">Add New Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="add-account-form">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="street" class="form-label">Street</label>
                                <input type="text" class="form-control" id="street" required>
                            </div>
                            <div class="mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" required>
                            </div>
                            <div class="mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" required>
                            </div>
                            <div class="mb-3">
                                <label for="zip" class="form-label">ZIP</label>
                                <input type="text" class="form-control" id="zip" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <!-- Script references -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>


        <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>


        <script>
            $(document).ready(function() {
                $('#myTable').DataTable({
                    "order": [[ 0, "asc" ]], // Initially sort by the first column
                    "pageLength": 10, // Show 10 rows per page
                });
            });
        </script>
        <script>
            $(document).ready(function() {
                $("table tbody").sortable({
                    axis: 'y',
                    handle: 'td',
                    update: function(event, ui) {
                        // You can perform actions here when the sorting has been updated
                    }
                });
            });

        </script>
        <script>
            $(document).ready(function() {
                $('.last-interaction-cell').hover(function() {
                    let accountId = $(this).data('account-id');
                    let $thisCell = $(this);  // Capture the hovered cell

                    // Hide all other tooltips
                    $('.last-interaction-cell').tooltip('hide');

                    // Fetch last 30-day interaction info
                    $.get('/last30', { id: accountId }, function(data) {
                        // Set custom attribute for tooltip content
                        $thisCell.attr('data-tooltip-content', data);

                        // Show the tooltip
                        $thisCell.tooltip('show');
                    });
                }, function() {
                    // Hide the tooltip when the mouse leaves the cell
                    $(this).tooltip('hide');
                }).tooltip({
                    trigger: 'manual',
                    html: true,  // Allow HTML in tooltip
                    title: function() {
                        return $(this).attr('data-tooltip-content');
                    }
                });
            });
        </script>

<script>
    $(document).ready(function() {
        // Double click event on the input field
        $('.note-input').dblclick(function() {
            // Lock all other notes before making current note editable
            $('.note-input').attr('readonly', true).removeClass('editing');
            $('.save-note-btn').hide();

            // Make current note editable
            $(this).removeAttr('readonly').addClass('editing');
            $(this).next('.save-note-btn').show();
        });

        // Save button click event
        $('.save-note-btn').click(function() {
            lockNote($(this).prev('.note-input'));
        });

        // Click outside of the editable area to lock it
        $(document).click(function(event) {
            if (!$(event.target).closest('.editing').length && !$(event.target).hasClass('save-note-btn')) {
                lockNote($('.editing'));
            }
        });

        function lockNote($noteInput) {
            // Here, you can add an AJAX call to save the note to the server
            // For now, I'll just revert the input to read-only and hide the save button

            $noteInput.attr('readonly', true).removeClass('editing');  // Make input read-only and remove editing class
            $noteInput.next('.save-note-btn').hide();  // Hide the save button
        }
    });


</script>
<script>
    $(document).ready(function() {
        $('.last-interaction-cell').tooltip({
            trigger: 'hover',
            delay: { "show": 500, "hide": 100 }, // Delay the tooltip appearance by 500ms
            boundary: 'window', // Prevents the tooltip from going outside the window
            placement: 'top',
            html: true,  // Allow HTML in tooltip
            title: function() {
                return $(this).attr('data-tooltip-content');
            }
        }).on("mouseenter", function() {
            var _this = this;
            $(this).tooltip("show");

            // Allow the tooltip to remain visible if hovered
            $(".tooltip").on("mouseenter", function() {
                $(_this).tooltip('show');
            }).on("mouseleave", function() {
                $(_this).tooltip('hide');
            });

        }).on("mouseleave", function() {
            var _this = this;
            setTimeout(function() {
                if (!$(".tooltip:hover").length) {
                    $(_this).tooltip("hide");
                }
            }, 100);
        });
    });

    // Double click event on the textarea
    $('.note-textarea').dblclick(function() {
        // Lock all other notes before making current note editable
        $('.note-textarea').attr('readonly', true).removeClass('editing');
        $('.save-note-btn').hide();

        // Make current note editable
        $(this).removeAttr('readonly').addClass('editing');
        $(this).next('.save-note-btn').show();
    });

    $(document).ready(function() {
        // Handle the expand/collapse functionality
        $('.note-expander').click(function(e) {
            e.stopPropagation(); // Prevent any other events like the textarea becoming editable

            var $textarea = $(this).siblings('.note-textarea');
            if ($textarea.css('max-height') !== 'none') {
                // If the textarea is limited in height, expand it
                $textarea.css('max-height', 'none').css('height', 'auto');
            } else {
                // Otherwise, collapse it back to the original max height
                $textarea.css('max-height', '150px').css('height', '150px');
            }
        });
    });


</script>

</div>
{% endblock %}