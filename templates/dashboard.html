{% extends "base.html" %}
{% block content %}
<style>

  .table-main-container tr{
    display: table;
    width: 100%;
    table-layout: fixed;  /* This ensures that the table takes up the full width */
  }

  .table-main-container th,
  .table-main-container td {
    display: table-cell;
    vertical-align: center;
    padding-left: 5px;
  }

  .table-scroll-container {
    overflow-x: auto;  /* Enable horizontal scrolling */
  }

  .table-main-container {
    min-width: 1200px;  /* Adjust this value to your preference */
  }

  /* Styles for the modal */
  .notes-modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
  }

  .notes-modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 50%;
  }

  .close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .close-button:hover,
  .close-button:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }

  /* Styles for the notes section in table */
  .notes-cell .paragraph-small.color-neutral-100 {
    background-color: lightslategrey;
    height: 90%;          /* slightly less than full height to give some padding effect */
    width: 90%;           /* slightly less than full width to give some padding effect */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    border: 2px solid white;   /* adds a border */
    border-radius: 5px;        /* rounds the corners */
    transition: transform 0.2s, box-shadow 0.2s; /* smoothens the hover effect */
    /*box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);    !* adds a subtle shadow *!*/
    text-align: center;        /* ensures text is centered */
    padding: 5px;              /* provides some space around the text */
  }

  .notes-cell .paragraph-small.color-neutral-100:hover {
    transform: translateY(-1px);    /* gives a subtle lift effect on hover */
    /*box-shadow: 0 4px 7px rgba(0, 0, 0, 0.3);   !* darkens the shadow a bit on hover *!*/
  }

  /* Styles for active column header */
  .sort-active {
    position: relative;

  }
  .sort-active div {
    font-weight: 800;
    text-transform: uppercase;

  }


  /* Styles for ascending & descending indicators */
  .sort-indicator {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
  }

  .sort-asc::after {
    content: "↑";
  }

  .sort-desc::after {
    content: "↓";
  }

  table th:hover {
    cursor: pointer;
  }



</style>
  <html data-wf-page="650f57fbea23e1c17aa1ef4f" data-wf-site="650f57c238e964525a27dd3f" lang="en">
  <link rel="stylesheet" type="text/css" href="../static/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="../static/css/webflow.css">
  <link rel="stylesheet" type="text/css" href="../static/css/code-output.webflow.css">


  <div class="page-wrapper-2">
    <div class="dashboard-main-section">
      <div class="dashboard-content">
        <div class="dashboard-main-content">
          <div class="container-default w-container">
            <div class="mg-bottom-32px">
              <div class="_2-items-wrap-container">
                <div id="w-node-be246f26-a62f-48d4-76dd-5d34ac0a0daa-7aa1ef4f">
                  {% if user %}
                  <h1 class="display-4 mg-bottom-4px">Welcome back, {{user.username}}</h1>
                  {% else %}
                  <h1 class="display-4 mg-bottom-4px">Welcome back!</h1>
                  {% endif %}
                  <p class="mg-bottom-0">Measure your sales ROI on your Tier 1 accounts.</p>
                </div>
<!--                <div id="w-node-be246f26-a62f-48d4-76dd-5d34ac0a0daf-7aa1ef4f" class="buttons-row">-->
<!--                  <a href="#" class="btn-secondary w-inline-block">-->
<!--                    <div class="flex-horizontal gap-column-6px">-->
<!--                      <div>Export data</div><img src="../static/img/downward-arrow-btn-icon-dashdark-webflow-ecommerce-template.svg" loading="eager" alt="" class="btn-icon-right max-h-12px">-->
<!--                    </div>-->
<!--                  </a>-->
<!--                  <a href="#" class="btn-primary w-inline-block">-->
<!--                    <div class="flex-horizontal gap-column-6px">-->
<!--                      <div>Create report</div>-->
<!--                    </div>-->
<!--                  </a>-->
<!--                </div>-->
              </div>
            </div>
            <div class="mg-bottom-16px">
              <div class="small-details-card-grid">
                <div id="w-node-be246f26-a62f-48d4-76dd-5d34ac0a0dbe-7aa1ef4f" class="card top-details">
                  <div class="flex-horizontal justify-space-between">
                    <div class="flex align-center gap-column-4px"><img src="../static/img/pageviews-icon-dashdark-webflow-template.svg" loading="eager" alt="Open Opps - ARRPlan" class="max-h-16px">
                      <div class="text-100 medium mg-top-2px">Open Opportunities</div>
                    </div>
                    <div class="dashdark-custom-icon details-icon"></div>
                  </div>
                  <div class="flex align-center gap-column-6px">
                    <div class="display-4">
                      {% if total_open > 1000000 %}
                      ${{ total_open/1000000 }}M
                      {% elif total_open > 1000 %}
                      ${{ total+open/1000 }}K
                      {% else %}
                      ${{ total_open }}
                      {% endif %}
                    </div>
                    <div>
                      <div class="status-badge green">
                        <div class="flex align-center gap-column-4px">
                          <div class="paragraph-small">28.4%</div>
                        </div>
                        <div class="dashdark-custom-icon icon-size-9px">^</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="w-node-be246f26-a62f-48d4-76dd-5d34ac0a0dd9-7aa1ef4f" class="card top-details">
                  <div class="flex-horizontal justify-space-between">
                    <div class="flex align-center gap-column-4px"><img src="../static/img/monthly-users-icon-dashdark-webflow-template.svg" loading="eager" alt="Lost Deals - ARRPlan" class="max-h-16px">
                      <div class="text-100 medium mg-top-2px">Lost Deals</div>
                    </div>
                    <div class="dashdark-custom-icon details-icon"></div>
                  </div>
                  <div class="flex align-center gap-column-6px">
                    <div class="display-4">$200k</div>
                    <div>
                      <div class="status-badge red">
                        <div class="flex align-center gap-column-4px">
                          <div class="paragraph-small">12.6%</div>
                        </div>
                        <div class="dashdark-custom-icon icon-size-9px">v</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="w-node-be246f26-a62f-48d4-76dd-5d34ac0a0df4-7aa1ef4f" class="card top-details">
                  <div class="flex-horizontal justify-space-between">
                    <div class="flex align-center gap-column-4px"><img src="../static/img/new-sign-ups-icon-dashdark-webflow-template.svg" loading="eager" alt="ARRPlan" class="max-h-16px">
                      <div class="text-100 medium mg-top-2px"> Tier 1 Interactions</div>
                    </div>
                    <div class="dashdark-custom-icon details-icon"></div>
                  </div>
                  <div class="flex align-center gap-column-6px">
                    <div class="display-4">{{tier1}}</div>
                    <div>
                      <div class="status-badge green">
                        <div class="flex align-center gap-column-4px">
                          <div class="paragraph-small">3.1%</div>
                        </div>
                        <div class="dashdark-custom-icon icon-size-9px">^</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="w-node-be246f26-a62f-48d4-76dd-5d34ac0a0e0f-7aa1ef4f" class="card top-details">
                  <div class="flex-horizontal justify-space-between">
                    <div class="flex align-center gap-column-4px"><img src="../static/img/subscriptions-icon-dashdark-webflow-template.svg" loading="eager" alt="Subscriptions - Dashdark X Webflow Template" class="max-h-16px">
                      <div class="text-100 medium mg-top-2px">Closed Revenue</div>
                    </div>
                    <div class="dashdark-custom-icon details-icon"></div>
                  </div>
                  <div class="flex align-center gap-column-6px">
                    <div class="display-4">
                      {% if total_closed > 1000000 %}
                      ${{ total_closed/1000000 }}M
                      {% elif total_closed > 1000 %}
                      ${{ total_closed/1000 }}K
                      {% else %}
                      ${{ total_closed }}
                      {% endif %}

                    </div>
                    <div>
                      <div class="status-badge green">
                        <div class="flex align-center gap-column-4px">
                          <div class="paragraph-small">11.3%</div>
                        </div>
                        <div class="dashdark-custom-icon icon-size-9px">^</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="mg-bottom-24px">
              <div class="_2-items-wrap-container align-end">
                <div>
                  <h2 class="display-4">Dashboard</h2>
                  <div data-hover="true" data-delay="0" class="mg-sides-0 position-relative---z-index-1 w-dropdown">
<!--                    <div class="small-dropdown-toggle w-dropdown-toggle">-->
<!--                      <div class="flex align-center gap-column-4px">-->
<!--                        <div class="dashdark-custom-icon line-height-1em"></div>-->
<!--                        <div class="text-50 medium">Select date</div>-->
<!--                      </div>-->
<!--                      <div class="line-rounded-icon card-dropdown-arrow"></div>-->
<!--                    </div>-->
<!--                    <nav class="small-dropdown-list w-dropdown-list">-->
<!--                      <div class="small-dropdown-links-container">-->
<!--                        <a href="#" class="small-dropdown-link w-dropdown-link">Jan 2024 - Dec 2024</a>-->
<!--                        <a href="#" class="small-dropdown-link w-dropdown-link">Jan 2023 - Dec 2023</a>-->
<!--                        <a href="#" class="small-dropdown-link w-dropdown-link">Jan 2022 - Dec 2022</a>-->
<!--                      </div>-->
<!--                    </nav>-->
                  </div>
                </div>
                <div class="buttons-row">
                  <a href="#" class="btn-secondary w-inline-block">
                    <div class="flex-horizontal gap-column-6px">
                      <div>Export data</div><img src="../static/img/downward-arrow-btn-icon-dashdark-webflow-ecommerce-template.svg" loading="eager" alt="" class="btn-icon-right max-h-12px">
                    </div>
                  </a>
                  <a href="#" class="btn-primary w-inline-block">
                    <div class="flex-horizontal gap-column-6px">
                      <div>Create report</div>
                    </div>
                  </a>
                </div>
              </div>
            </div>
            <!--            TABS NAVIGATION-->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Accounts</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Opportunities</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">Events</button>
              </li>
            </ul>

            <!--            TABS CONTENT-->
            <div class="tab-content" id="myTabContent">
              <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <!--                ACCOUNTS TAB-->
                <div class="mg-bottom-24px">
                  <div class="grid-2-columns gap-20px">
                    <div id="w-node-_38b4a65e-7f82-4f13-d3fc-261e38ea4042-ea54d9ce">
                      <div id="w-node-_28f58b49-e289-bfad-3672-3ddb30359092-30359092" class="grid-1-column">
                        <div class="card overflow-hidden">
                          <div class="_2-items-wrap-container pd-32px---28px">
                            <div class="text-300 medium color-neutral-100">Account List</div>
                            <div data-hover="true" data-delay="0" data-w-id="9cc462d8-bb30-3faf-01e2-89a59eb05ad4" class="mg-sides-0 position-relative---z-index-1 w-dropdown">
                              <div class="small-dropdown-toggle w-dropdown-toggle">
                                <div class="flex align-center gap-column-4px">
                                  <div class="dashdark-custom-icon line-height-1em"></div>
                                  <div class="text-50 medium">Jan 2024</div>
                                </div>
                                <div class="line-rounded-icon card-dropdown-arrow"></div>
                              </div>
                              <nav class="small-dropdown-list w-dropdown-list">
                                <div class="small-dropdown-links-container">
                                  <a href="#" class="small-dropdown-link w-dropdown-link">Dec 2023</a>
                                  <a href="#" class="small-dropdown-link w-dropdown-link">Nov 2023</a>
                                  <a href="#" class="small-dropdown-link w-dropdown-link">Oct 2023</a>
                                </div>
                              </nav>
                            </div>
                          </div>
                          <div class="table-scroll-container">
                            <!--          START OF ACCOUNT TABLE-->
                            <table class="table-main-container" id="accountsTable">
                              <thead>
                              <tr class="recent-orders-table-row table-header">
                                <!-- COLUMN 1 HEADER -->
                                <th>
                                  <div class="flex align-center gap-column-6px">
                                    <img src="../static/img/order-table-header-icon-dashdark-webflow-template.svg" alt="">
                                    <div class="text-50 semibold color-neutral-100">Account Name</div>
                                  </div>
                                </th>
                                <!-- COLUMN 2 HEADER -->
                                <th>
                                  <div class="flex align-center gap-column-6px">
                                    <img src="../static/img/date-table-header-icon-dashdark-webflow-template.svg" alt="">
                                    <div class="text-50 semibold color-neutral-100">Score</div>
                                  </div>
                                </th>
                                <!-- COLUMN 3 HEADER -->
                                <th>
                                  <div class="flex align-center gap-column-6px">
                                    <img src="../static/img/date-table-header-icon-dashdark-webflow-template.svg" alt="">
                                    <div class="text-50 semibold color-neutral-100">State</div>
                                  </div>
                                </th>
                                <!-- COLUMN 4 HEADER -->
                                <th>
                                  <div class="flex align-center gap-column-6px">
                                    <img src="../static/img/date-table-header-icon-dashdark-webflow-template.svg" alt="">
                                    <div class="text-50 semibold color-neutral-100">Industry</div>
                                  </div>
                                </th>
                                <!-- COLUMN 5 HEADER -->
                                <th>
                                  <div class="flex align-center gap-column-6px">
                                    <img src="../static/img/date-table-header-icon-dashdark-webflow-template.svg" alt="">
                                    <div class="text-50 semibold color-neutral-100">Notes</div>
                                  </div>
                                </th>
                                <!-- COLUMN 6 HEADER -->
                                <th>
                                  <div class="flex align-center gap-column-6px">
                                    <img src="../static/img/status-table-header-icon-dashdark-webflow-template.svg" alt="">
                                    <div class="text-50 semibold color-neutral-100">Account ID</div>
                                  </div>
                                </th>
                                <!-- COLUMN 7 HEADER -->
                                <th>
                                  <div class="flex align-center gap-column-6px">
                                    <div class="text-50 semibold color-neutral-100">Top Contacts</div>
                                  </div>
                                </th>
                                <!-- COLUMN 8 HEADER -->
                                <th>
                                  <div class="flex align-center gap-column-6px">
                                    <div class="text-50 semibold color-neutral-100">Last Interaction</div>
                                  </div>
                                </th>
                              </tr>
                              </thead>
                              <tbody>
                              {% for account in accounts %}
                              <tr class="recent-orders-table-row">
                                <!-- COLUMN 1 -->
                                <td>
                                  <div class="flex align-center">
                                    <div class="paragraph-small color-neutral-100">{{ account.Name }}</div>
                                  </div>
                                </td>
                                <!-- COLUMN 2 -->
                                <td>
                                  <div class="flex align-center">
                                    <div class="paragraph-small color-neutral-100">{{ account.Score }}</div>
                                  </div>
                                </td>
                                <!-- COLUMN 3 -->
                                <td>
                                  <div class="flex align-center">
                                    <div class="paragraph-small color-neutral-100">{{ account.BillingState }}</div>
                                  </div>
                                </td>
                                <!-- COLUMN 4 -->
                                <td>
                                  <div class="flex align-center">
                                    <div class="paragraph-small color-neutral-100">{{ account.Industry }}</div>
                                  </div>
                                </td>
                                <!-- COLUMN 5 -->
                                <td class="notes-cell">
                                  <div class="flex align-center">
                                    <div class="paragraph-small color-neutral-100" data-account-id="{{ account.Id }}">{{ account.Notes }}</div>
                                  </div>
                                </td>

                                <!-- COLUMN 6 -->
                                <td>
                                  <div class="flex align-center">
                                    <div class="status-badge green">
                                      <div class="flex align-center gap-column-4px">
                                        <div class="small-dot _4px bg-green-300"></div>
                                        <div class="paragraph-small">{{ account.Id }}</div>
                                      </div>
                                    </div>
                                  </div>
                                </td>
                                <!-- COLUMN 7 -->
                                <td>
                                  <div class="flex align-center">
                                    <div class="paragraph-small color-neutral-100"><a href="#">{{ contact_count[account.Id] }}</a></div>
                                  </div>
                                </td>

                                <!-- COLUMN 8 -->
                                <td>
                                  <div class="flex align-center">
                                    <div class="paragraph-small color-neutral-100">
                                      {% set last_interaction = get_last_interaction(account.Id) %}
                                      {% if last_interaction != None %}
                                      <a href="{{ url_for('interaction_details', interaction_id=last_interaction.id) }}">{{ last_interaction.timestamp|time_since }}</a></div>
                                  </div>
                                  {% else %}
                                  :(
                                  {% endif %}
                                </td>
                              </tr>
                              {% endfor %}
                              </tbody>
                            </table>
                          </div>

                          <!--          END OF ACCOUNT TABLE-->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Notes Modal -->
              <div id="notesModal" class="modal fade" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="notesModalLabel" style="color: #0a163c">Edit Notes</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <textarea id="notesText" class="form-control" rows="5"></textarea>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button id="saveNotes" type="button" class="btn btn-primary">Save changes</button>
                    </div>
                  </div>
                </div>
              </div>


              <!--              TAB 2-->
              <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">2</div>
              <!--              TAB 3-->
              <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">3</div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="loading-bar-wrapper">
    <div class="loading-bar"></div>
  </div>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<!--  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=650b5aa1c83014362c816d0e" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>-->
  <script src="../static/js/webflow.js" type="text/javascript"></script>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=650f57c238e964525a27dd3f" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script>
    // Get the modal, close button, and save button elements
    var notesModal = new bootstrap.Modal(document.getElementById('notesModal'), {
      keyboard: true
    });

    // Open the modal when the notes section is double-clicked
    var notesElements = document.querySelectorAll(".notes-cell .paragraph-small.color-neutral-100");
    var currentAccountId;

    // Open the modal when the notes section is clicked
    notesElements.forEach(function(noteElement) {
      noteElement.addEventListener("click", function() {
        currentAccountId = this.getAttribute("data-account-id");
        currentNoteElement = this; // Store the reference to the clicked element
        document.getElementById("notesText").value = this.innerText;
        notesModal.show();
      });
    });

    document.getElementById("saveNotes").addEventListener("click", function() {
      var noteText = document.getElementById("notesText").value;

      fetch("/save_notes", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
          "account_id": currentAccountId,
          "note_text": noteText
        })
      })
              .then(response => response.json())
              .then(data => {
                if(data.status === "success") {
                  currentNoteElement.innerText = noteText; // Update the note in the table
                  notesModal.hide(); // Close the modal
                } else {
                  // Handle error
                  console.error("Error updating notes:", data.message);
                }
              })
              .catch(error => {
                console.error("Error:", error);
              });
    });




  </script>
  <script>
    // Function to sort table
    function sortTable(table, columnIndex, ascending = true) {
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));

      // Sort rows based on content of specified column
      const sortedRows = rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].innerText.trim();
        const bValue = b.cells[columnIndex].innerText.trim();

        if (!isNaN(aValue) && !isNaN(bValue)) {
          return ascending ? parseFloat(aValue) - parseFloat(bValue) : parseFloat(bValue) - parseFloat(aValue);
        } else {
          return ascending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
        }
      });

      // Append sorted rows back to the table
      tbody.innerHTML = "";
      sortedRows.forEach(row => tbody.appendChild(row));
    }

    // Attach event listener to each header
    document.addEventListener("DOMContentLoaded", function() {
      const table = document.getElementById("accountsTable");
      const headers = Array.from(table.querySelectorAll("thead th"));
      let ascending = true;

      headers.forEach((header, index) => {
        header.addEventListener("click", () => {
          // Remove active class from all headers
          headers.forEach(h => h.classList.remove("sort-active", "sort-asc", "sort-desc"));

          // Apply the active class to the clicked header
          header.classList.add("sort-active");

          // Call the sort function
          sortTable(table, index, ascending);
          ascending = !ascending; // Toggle the sorting direction
        });
      });

    });
  </script>



  {% endblock %}